<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>85e18663f0c54ad4bf197c20347e37c8</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<section id="capstone-project---cv---pneumonia-detection"
class="cell markdown" id="XZtMqmqkRxrs">
<h1>CAPSTONE PROJECT - CV - PNEUMONIA DETECTION</h1>
<h2 id="authors-cv1---group--4">Authors: CV1 - GROUP- 4</h2>
</section>
<section id="domain-health-care" class="cell markdown"
id="AwbZAguxZs_j">
<h1>DOMAIN: Health Care</h1>
<p><strong>• CONTEXT:</strong> Computer vision can be used in health
care for identifying diseases. In Pneumonia detection we need to detect
Inflammation of the lungs. In this challenge, you’re required to build
an algorithm to detect a visual signal for pneumonia in medical images.
Specifically, your algorithm needs to automatically locate lung
opacities on chest radiographs.</p>
<p><strong>• DATA DESCRIPTION:</strong> In the dataset, some of the
features are labeled “Not Normal No Lung Opacity”. This extra third
class indicates that while pneumonia was determined not to be present,
there was nonetheless some type of abnormality on the image and
oftentimes this finding may mimic the appearance of true pneumonia.
Dicom original images: - Medical images are stored in a special format
called DICOM files (*.dcm). They contain a combination of header
metadata as well as underlying raw image arrays for pixel data.</p>
<p>Dataset has been attached along with this project. Please use the
same for this capstone project. Original link to the dataset : <a
href="https://www.kaggle.com/c/rsna-pneumonia-detection-challenge/data"
class="uri">https://www.kaggle.com/c/rsna-pneumonia-detection-challenge/data</a>
[ for your reference only ]. You can refer to the details of the dataset
in the above link</p>
<p>Acknowledgements: <a
href="https://www.kaggle.com/c/rsna-pneumonia-detection-challenge/overview/acknowledgements"
class="uri">https://www.kaggle.com/c/rsna-pneumonia-detection-challenge/overview/acknowledgements</a>.</p>
<p><strong>• PROJECT OBJECTIVE:</strong> Design a DL based algorithm for
detecting pneumonia.</p>
<p><strong>• PROJECT TASK:</strong></p>
<p>Milestone 2: Input: Preprocessed output from Milestone-1</p>
<p>Process: ‣ Step 1: Fine tune the trained basic CNN models for
classification.</p>
<p>‣ Step 2: Apply Transfer Learning model for classification</p>
<h2
id="step-3-design-train-and-test-rcnn--its-hybrids-based-object-detection-models-to-impose-the-bounding-box-or-mask-over-the-area-of-interest">Step
3: Design, train and test RCNN &amp; its hybrids based object detection
models to impose the bounding box or mask over the area of
interest.</h2>
<p>‣ Step 4: Pickle the model for future prediction</p>
<p>‣ Step 5: Final Report</p>
<p>Submission: Final report, Jupyter Notebook with all the steps in
Milestone-1 and Milestone-2</p>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-08-06T07:32:01.328198Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-08-06T07:32:01.327784Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-08-06T07:32:15.516222Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-08-06T07:32:15.514935Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-08-06T07:32:01.328168Z&quot;}"
id="U3hhoi1rRstG" data-outputId="cd505b42-4d15-4399-c4a0-e562856c06df"
data-trusted="true">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>pip install pydicom</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Collecting pydicom
  Downloading pydicom-2.4.2-py3-none-any.whl (1.8 MB)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 0.0/1.8 MB ? eta -:--:--━━╸━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 0.1/1.8 MB 3.8 MB/s eta 0:00:01━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━╸━━━ 1.6/1.8 MB 24.0 MB/s eta 0:00:01━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 1.8/1.8 MB 21.0 MB/s eta 0:00:00

Successfully installed pydicom-2.4.2
</code></pre>
</div>
</div>
<div class="cell code"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-08-06T07:32:15.520408Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-08-06T07:32:15.520101Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-08-06T07:32:29.861231Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-08-06T07:32:29.860138Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-08-06T07:32:15.520380Z&quot;}"
id="ilAomRruaM2M" data-trusted="true">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Import necessary libraries</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> csv</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> itertools</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> cv2</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> PIL</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pickle</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torchvision</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pydicom</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">&quot;ignore&quot;</span>)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>plt.rcParams[<span class="st">&quot;axes.grid&quot;</span>] <span class="op">=</span> <span class="va">False</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> preprocessing</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelBinarizer</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, confusion_matrix, precision_score, recall_score, f1_score, precision_recall_curve, auc,classification_report, roc_curve</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> GridSearchCV</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> skimage.transform <span class="im">import</span> resize</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> tensorflow <span class="im">as</span> tf</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow <span class="im">import</span> keras</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> SGD,Adam</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Sequential</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.utils <span class="im">import</span> Sequence</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> optimizers</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.applications.inception_v3 <span class="im">import</span> InceptionV3</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> regularizers</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Convolution2D, Activation, SpatialDropout2D</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Dense,Dropout,Flatten,Conv2D, MaxPooling2D, MaxPool2D, GlobalMaxPooling2D, BatchNormalization</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.applications.vgg16 <span class="im">import</span> VGG16</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.applications.vgg16 <span class="im">import</span> preprocess_input</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.applications.resnet50 <span class="im">import</span> ResNet50</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.applications.resnet50 <span class="im">import</span> preprocess_input</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> backend</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> layers, models</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Conv2D, Activation, BatchNormalization ,Conv2DTranspose</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> UpSampling2D, Input, Concatenate</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.models <span class="im">import</span> Model</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.applications <span class="im">import</span> MobileNet , VGG19</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.callbacks <span class="im">import</span> EarlyStopping, ReduceLROnPlateau</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.metrics <span class="im">import</span> Recall, Precision</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras <span class="im">import</span> backend <span class="im">as</span> K</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.applications.mobilenet <span class="im">import</span> MobileNet</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.layers <span class="im">import</span> Concatenate, UpSampling2D, Conv2D, Reshape, GlobalAveragePooling2D</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.preprocessing.image <span class="im">import</span> ImageDataGenerator</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.optimizers <span class="im">import</span> RMSprop</span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tensorflow.keras.utils <span class="im">import</span> to_categorical</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.utils <span class="im">import</span> to_categorical</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> regularizers</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.optimizers <span class="im">import</span> SGD</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.wrappers.scikit_learn <span class="im">import</span> KerasClassifier</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras <span class="im">import</span> optimizers</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> keras.utils <span class="im">import</span> np_utils</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> zipfile <span class="im">import</span> ZipFile</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> tqdm <span class="im">import</span> tqdm_notebook</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.patches <span class="im">import</span> Rectangle</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> imgaug <span class="im">import</span> augmenters <span class="im">as</span> iaa</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> imgaug.augmentables.bbs <span class="im">import</span> BoundingBox, BoundingBoxesOnImage</span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PIL <span class="im">import</span> Image</span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> numpy <span class="im">import</span> asarray</span></code></pre></div>
</div>
<div class="cell markdown" id="HqM47gIHgdxf">
##Step 1: Import the data.
##Step 2: Map training and testing images to its classes.
<p>##Step 3: Map training and testing images to its annotations.</p>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-08-06T07:32:29.863703Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-08-06T07:32:29.862660Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-08-06T07:32:29.868455Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-08-06T07:32:29.867393Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-08-06T07:32:29.863663Z&quot;}"
id="UMaA5lwXZ346" data-outputId="d8572edd-a896-4695-b257-3eeb73b5c14f"
data-trusted="true">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive  <span class="co">#Google drive mount</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>drive.mount(<span class="st">&#39;/content/drive&#39;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Mounted at /content/drive
</code></pre>
</div>
</div>
<div class="cell code"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-08-06T07:32:29.872191Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-08-06T07:32:29.871128Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-08-06T07:32:29.997130Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-08-06T07:32:29.996129Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-08-06T07:32:29.872157Z&quot;}"
id="3CMrEthCZ57R" data-trusted="true">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>classInfo <span class="op">=</span> pd.read_csv(<span class="st">&#39;/content/drive/My Drive/Colab Notebooks/My Python Projects/CAPSTONE PROJECT/CV capstone/stage_2_detailed_class_info.csv&#39;</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>trainlabels <span class="op">=</span> pd.read_csv(<span class="st">&quot;/content/drive/My Drive/Colab Notebooks/My Python Projects/CAPSTONE PROJECT/CV capstone/stage_2_train_labels.csv&quot;</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>trainImagesPath <span class="op">=</span> <span class="st">&quot;/content/drive/My Drive/Colab Notebooks/My Python Projects/CAPSTONE PROJECT/CV capstone/stage_2_train_images.zip&quot;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>testImagesPath <span class="op">=</span> <span class="st">&quot;/content/drive/My Drive/Colab Notebooks/My Python Projects/CAPSTONE PROJECT/CV capstone/stage_2_test_images.zip&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>sampleSubPath <span class="op">=</span> Path(<span class="st">&quot;/content/drive/My Drive/Colab Notebooks/My Python Projects/CAPSTONE PROJECT/CV capstone/stage_2_sample_submission.csv&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-08-06T07:32:29.999200Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-08-06T07:32:29.998828Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-08-06T07:32:30.004356Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-08-06T07:32:30.003042Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-08-06T07:32:29.999164Z&quot;}"
id="O6dNT9hJZ-ih" data-trusted="true">
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Unzip the train images file</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> ZipFile(trainImagesPath,<span class="st">&#39;r&#39;</span>) <span class="im">as</span> zipfile:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  zipfile.extractall(<span class="st">&quot;/content/drive/My Drive/Colab Notebooks/My Python Projects/CAPSTONE PROJECT/Train images/&quot;</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-execution="{&quot;iopub.execute_input&quot;:&quot;2023-08-06T07:32:30.007190Z&quot;,&quot;iopub.status.busy&quot;:&quot;2023-08-06T07:32:30.006288Z&quot;,&quot;iopub.status.idle&quot;:&quot;2023-08-06T07:32:30.016617Z&quot;,&quot;shell.execute_reply&quot;:&quot;2023-08-06T07:32:30.015635Z&quot;,&quot;shell.execute_reply.started&quot;:&quot;2023-08-06T07:32:30.007155Z&quot;}"
id="9iWDDs0MalvF" data-trusted="true">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Unzip the test images file</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> ZipFile(testImagesPath,<span class="st">&#39;r&#39;</span>) <span class="im">as</span> zip1:</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  zip1.extractall(<span class="st">&quot;/content/drive/My Drive/Colab Notebooks/My Python Projects/CAPSTONE PROJECT/Test images/&quot;</span>)</span></code></pre></div>
</div>
<section id="faster-rcnn" class="cell markdown" id="VFycvnq9XyMF">
<h1>Faster-RCNN</h1>
</section>
<div class="cell code" id="cwYYcwLM24Qx" data-trusted="true">
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>seed <span class="op">=</span> <span class="dv">42</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>num_classes <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>batch_size <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>train_img_size <span class="op">=</span> <span class="dv">256</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>origin_img_size <span class="op">=</span> <span class="dv">1024</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>scale_factor <span class="op">=</span> train_img_size <span class="op">/</span> origin_img_size</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>np.random.seed(seed)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>TRAIN_DIR <span class="op">=</span> <span class="st">&quot;Train images/stage_2_train_images/&quot;</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>TEST_DIR <span class="op">=</span> <span class="st">&quot;Test images/stage_2_test_images/&quot;</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>ROOT_DIR <span class="op">=</span> <span class="st">&quot;/content/drive/My Drive/Colab Notebooks/My Python Projects/CAPSTONE PROJECT/&quot;</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>LABELS_FILE <span class="op">=</span> <span class="st">&quot;CV capstone/stage_2_train_labels.csv&quot;</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>SUBMISSION_FILE <span class="op">=</span> <span class="st">&quot;CV capstone/stage_2_sample_submission.csv&quot;</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>rcnn_losses <span class="op">=</span> [<span class="st">&quot;loss_objectness&quot;</span>, <span class="st">&quot;loss_box_reg&quot;</span>, <span class="st">&quot;loss_rpn_box_reg&quot;</span>]</span></code></pre></div>
</div>
<div class="cell code" id="ylFlAhJU24Qy" data-trusted="true">
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>train_imgs <span class="op">=</span> os.listdir(os.path.join(ROOT_DIR, TRAIN_DIR))</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>test_imgs <span class="op">=</span>  [patienId <span class="op">+</span> <span class="st">&quot;.dcm&quot;</span> <span class="cf">for</span> patienId <span class="kw">in</span> pd.read_csv(os.path.join(ROOT_DIR, SUBMISSION_FILE)).patientId]</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="wUskkK1g24Qy" data-outputId="bda151b4-c1c4-4a3f-daa5-c1ca8b9af98b"
data-trusted="true">
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>train_imgs, valid_imgs <span class="op">=</span> train_test_split(train_imgs, test_size<span class="op">=</span><span class="fl">0.25</span>, random_state<span class="op">=</span>seed)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Number of training samples: </span><span class="sc">{</span><span class="bu">len</span>(train_imgs)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Number of validation samples: </span><span class="sc">{</span><span class="bu">len</span>(valid_imgs)<span class="sc">}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Number of training samples: 20013
Number of validation samples: 6671
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}"
id="KrsNsBC224Qy" data-outputId="1237d58a-c155-4883-ad52-b3d9fa9b1188"
data-trusted="true">
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>train_label_df <span class="op">=</span> pd.read_csv(os.path.join(ROOT_DIR, LABELS_FILE))</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>train_label_df.head()</span></code></pre></div>
<div class="output execute_result" data-execution_count="120">


  <div id="df-ba1a210a-e03b-4cd3-8443-369eebea6a9f">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>patientId</th>
      <th>x</th>
      <th>y</th>
      <th>width</th>
      <th>height</th>
      <th>Target</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0004cfab-14fd-4e49-80ba-63a80b6bddd6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>00313ee0-9eaa-42f4-b0ab-c148ed3241cd</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>00322d4d-1c29-4943-afc9-b6754be640eb</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>003d8fa0-6bf1-40ed-b54c-ac657f8495c5</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>00436515-870c-4b36-a041-de91049b9ab4</td>
      <td>264.0</td>
      <td>152.0</td>
      <td>213.0</td>
      <td>379.0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-ba1a210a-e03b-4cd3-8443-369eebea6a9f')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>



    <div id="df-d24cd25d-9e00-45c8-8f2a-d4b7e867a27d">
      <button class="colab-df-quickchart" onclick="quickchart('df-d24cd25d-9e00-45c8-8f2a-d4b7e867a27d')"
              title="Suggest charts."
              style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>
    </div>

<style>
  .colab-df-quickchart {
    background-color: #E8F0FE;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: #1967D2;
    height: 32px;
    padding: 0 0 0 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: #E2EBFA;
    box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: #174EA6;
  }

  [theme=dark] .colab-df-quickchart {
    background-color: #3B4455;
    fill: #D2E3FC;
  }

  [theme=dark] .colab-df-quickchart:hover {
    background-color: #434B5C;
    box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
    filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
    fill: #FFFFFF;
  }
</style>

    <script>
      async function quickchart(key) {
        const containerElement = document.querySelector('#' + key);
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      }
    </script>

      <script>

function displayQuickchartButton(domScope) {
  let quickchartButtonEl =
    domScope.querySelector('#df-d24cd25d-9e00-45c8-8f2a-d4b7e867a27d button.colab-df-quickchart');
  quickchartButtonEl.style.display =
    google.colab.kernel.accessAllowed ? 'block' : 'none';
}

        displayQuickchartButton(document);
      </script>
      <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-ba1a210a-e03b-4cd3-8443-369eebea6a9f button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-ba1a210a-e03b-4cd3-8443-369eebea6a9f');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>

</div>
</div>
<section
id="our-model-require-box-coordinates-in-format-x0-x1-we-also-multiply-bounding-box-coordinates-with-scale_factor-since-we-will-train-our-model-on-images-of-size-256-instead-of-their-original-size-1024-r-cnn-also-require-area-of-bounding-box-as-input"
class="cell markdown" id="ML2vuX4z24Qy">
<h4>Our model require box coordinates in format X0, X1. We also multiply
bounding box coordinates with scale_factor since we will train our model
on images of size 256 instead of their original size 1024. R-CNN also
require area of bounding box as input.</h4>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:206}"
id="91j2WHu124Qy" data-outputId="09ae8a7c-d44e-4f86-ffa0-d7b25cdef5f1"
data-trusted="true">
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>isna_count <span class="op">=</span> <span class="bu">len</span>(train_label_df[train_label_df.Target <span class="op">==</span> <span class="dv">0</span>]) <span class="co"># number of images without bounding box</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>train_label_df <span class="op">=</span> train_label_df[train_label_df.Target <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>train_label_df.rename(columns<span class="op">=</span>{<span class="st">&quot;x&quot;</span>: <span class="st">&quot;X0&quot;</span>, <span class="st">&quot;y&quot;</span>: <span class="st">&quot;Y0&quot;</span>}, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>train_label_df[<span class="st">&quot;X1&quot;</span>] <span class="op">=</span> train_label_df[<span class="st">&quot;X0&quot;</span>] <span class="op">+</span> train_label_df[<span class="st">&quot;width&quot;</span>]</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>train_label_df[<span class="st">&quot;Y1&quot;</span>] <span class="op">=</span> train_label_df[<span class="st">&quot;Y0&quot;</span>] <span class="op">+</span> train_label_df[<span class="st">&quot;height&quot;</span>]</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>train_label_df[[<span class="st">&quot;X0&quot;</span>, <span class="st">&quot;X1&quot;</span>, <span class="st">&quot;Y0&quot;</span>, <span class="st">&quot;Y1&quot;</span>]] <span class="op">=</span> train_label_df[[<span class="st">&quot;X0&quot;</span>, <span class="st">&quot;X1&quot;</span>, <span class="st">&quot;Y0&quot;</span>, <span class="st">&quot;Y1&quot;</span>]] <span class="op">*</span> scale_factor</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>train_label_df[<span class="st">&quot;area&quot;</span>] <span class="op">=</span> train_label_df[<span class="st">&quot;width&quot;</span>] <span class="op">*</span> scale_factor <span class="op">*</span> train_label_df[<span class="st">&quot;height&quot;</span>] <span class="op">*</span> scale_factor</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>train_label_df.drop([<span class="st">&quot;width&quot;</span>, <span class="st">&quot;height&quot;</span>], axis<span class="op">=</span><span class="dv">1</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>train_label_df.head()</span></code></pre></div>
<div class="output execute_result" data-execution_count="121">


  <div id="df-ba58b0c5-eb10-4031-a969-82c63549b121">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>patientId</th>
      <th>X0</th>
      <th>Y0</th>
      <th>Target</th>
      <th>X1</th>
      <th>Y1</th>
      <th>area</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>4</th>
      <td>00436515-870c-4b36-a041-de91049b9ab4</td>
      <td>66.00</td>
      <td>38.00</td>
      <td>1</td>
      <td>119.25</td>
      <td>132.75</td>
      <td>5045.4375</td>
    </tr>
    <tr>
      <th>5</th>
      <td>00436515-870c-4b36-a041-de91049b9ab4</td>
      <td>140.50</td>
      <td>38.00</td>
      <td>1</td>
      <td>204.50</td>
      <td>151.25</td>
      <td>7248.0000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>00704310-78a8-4b38-8475-49f4573b2dbb</td>
      <td>80.75</td>
      <td>144.25</td>
      <td>1</td>
      <td>120.75</td>
      <td>170.25</td>
      <td>1040.0000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>00704310-78a8-4b38-8475-49f4573b2dbb</td>
      <td>173.75</td>
      <td>143.75</td>
      <td>1</td>
      <td>214.25</td>
      <td>178.00</td>
      <td>1387.1250</td>
    </tr>
    <tr>
      <th>14</th>
      <td>00aecb01-a116-45a2-956c-08d2fa55433f</td>
      <td>72.00</td>
      <td>80.50</td>
      <td>1</td>
      <td>95.50</td>
      <td>114.25</td>
      <td>793.1250</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-ba58b0c5-eb10-4031-a969-82c63549b121')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>



    <div id="df-ce1f0119-96d4-41bc-b0e0-12799d5b1014">
      <button class="colab-df-quickchart" onclick="quickchart('df-ce1f0119-96d4-41bc-b0e0-12799d5b1014')"
              title="Suggest charts."
              style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>
    </div>

<style>
  .colab-df-quickchart {
    background-color: #E8F0FE;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: #1967D2;
    height: 32px;
    padding: 0 0 0 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: #E2EBFA;
    box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: #174EA6;
  }

  [theme=dark] .colab-df-quickchart {
    background-color: #3B4455;
    fill: #D2E3FC;
  }

  [theme=dark] .colab-df-quickchart:hover {
    background-color: #434B5C;
    box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
    filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
    fill: #FFFFFF;
  }
</style>

    <script>
      async function quickchart(key) {
        const containerElement = document.querySelector('#' + key);
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      }
    </script>

      <script>

function displayQuickchartButton(domScope) {
  let quickchartButtonEl =
    domScope.querySelector('#df-ce1f0119-96d4-41bc-b0e0-12799d5b1014 button.colab-df-quickchart');
  quickchartButtonEl.style.display =
    google.colab.kernel.accessAllowed ? 'block' : 'none';
}

        displayQuickchartButton(document);
      </script>
      <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-ba58b0c5-eb10-4031-a969-82c63549b121 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-ba58b0c5-eb10-4031-a969-82c63549b121');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>

</div>
</div>
<section
id="now-lets-check-how-many-images-have-zero-one-or-more-bounding-boxes"
class="cell markdown" id="E9KyoETJ24Qy">
<h4>Now let´s check how many images have zero, one or more bounding
boxes</h4>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:452}"
id="MpM_kLsy24Qz" data-outputId="bd9dd537-31be-40ec-9ea4-310d6c1d6b5a"
data-trusted="true">
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> Counter</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>cnt <span class="op">=</span> Counter(train_label_df.patientId)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>sample_batch <span class="op">=</span> [sample[<span class="dv">0</span>] <span class="op">+</span> <span class="st">&quot;.dcm&quot;</span> <span class="cf">for</span> sample <span class="kw">in</span> cnt.most_common(<span class="dv">2</span>)] <span class="co"># We will take two imgs with 4 boxes to display</span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>counts <span class="op">=</span> pd.Series(cnt.values()).value_counts()</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>counts[<span class="dv">0</span>] <span class="op">=</span> isna_count</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Box frequency&quot;</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Count&quot;</span>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>plt.xticks(counts.index)</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>plt.bar(counts.index, counts)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> cnt</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_46156ca0a71b4f3087f219c9c1dd58c1/9919f7adb9a585aff747292f473f020285a74303.png" /></p>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="u0Y7xYY124Qz" data-outputId="e9aece32-dce7-4332-dfb9-ae3a3b2a4dbd"
data-trusted="true">
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>counts.sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="123">
<pre><code>0    20672
2     3266
1     2614
3      119
4       13
dtype: int64</code></pre>
</div>
</div>
<section
id="we-see-that-most-of-images-do-not-have-any-bounding-box-there-is-also-a-handful-of-images-with-three-and-four-bounding-boxes-previously-we-calculated-bounding-boxes-area-so-we-can-now-display-area-distribution"
class="cell markdown" id="3JCNeHkH24Qz">
<h4>We see that most of images do not have any bounding box. There is
also a handful of images with three and four bounding boxes. Previously
we calculated bounding boxes area so we can now display area
distribution.</h4>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:465}"
id="Svc0sOCN24Qz" data-outputId="7d14fcb3-3760-4462-8802-23552e80733a"
data-trusted="true">
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">18</span>, <span class="dv">5</span>))</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>sns.histplot(data<span class="op">=</span>train_label_df, x<span class="op">=</span><span class="st">&quot;area&quot;</span>, ax<span class="op">=</span>axs[<span class="dv">0</span>])</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>sns.boxplot(y<span class="op">=</span>train_label_df[<span class="st">&quot;area&quot;</span>])</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_46156ca0a71b4f3087f219c9c1dd58c1/94585b79575fe758333f72ea6fd1a4441843a1d1.png" /></p>
</div>
</div>
<section
id="we-see-that-most-of-boxes-have-area-smaller-than-7000-there-are-also-outliers-with-area-greater-than-15000-now-we-will-define-some-helper-functions-to-display-samples-batch-along-with-boxes"
class="cell markdown" id="KYkbRhja24Qz">
<h4>We see that most of boxes have area smaller than 7000. There are
also outliers with area greater than 15000. Now we will define some
helper functions to display samples batch along with boxes.</h4>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:995}"
id="0ixe3Z0w24Qz" data-outputId="f399ff5b-273a-4485-bee4-c41c8841d86f"
data-trusted="true">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.utils <span class="im">import</span> draw_bounding_boxes, make_grid</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> find_boxes(img_name, label_df):</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    patient_id <span class="op">=</span> img_name.split(<span class="st">&quot;.&quot;</span>)[<span class="dv">0</span>]</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    boxes <span class="op">=</span> label_df[label_df.patientId <span class="op">==</span> patient_id]</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    boxes_coord <span class="op">=</span> boxes[[<span class="st">&quot;X0&quot;</span>, <span class="st">&quot;Y0&quot;</span>, <span class="st">&quot;X1&quot;</span>, <span class="st">&quot;Y1&quot;</span>]].to_numpy()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> boxes_coord, boxes.area.to_numpy()</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_images(img_names, label_df, resize):</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>    batch <span class="op">=</span> []</span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> img_name <span class="kw">in</span> img_names:</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> os.path.join(ROOT_DIR, TRAIN_DIR, img_name)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> PIL.Image.fromarray(pydicom.dcmread(img_path).pixel_array).convert(<span class="st">&quot;RGB&quot;</span>)</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> img.resize(resize)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> np.array(img)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        boxes, _ <span class="op">=</span> find_boxes(img_name, label_df)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> torch.tensor(img, dtype<span class="op">=</span>torch.uint8)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>        boxes <span class="op">=</span> torch.tensor(boxes, dtype<span class="op">=</span>torch.int32)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>        batch.append((img, boxes))</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> batch</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_samples(batch, n_rows<span class="op">=</span><span class="dv">3</span>, n_cols<span class="op">=</span><span class="dv">5</span>, box_color<span class="op">=</span><span class="st">&quot;red&quot;</span>, titles<span class="op">=</span><span class="va">None</span>, box_width<span class="op">=</span><span class="dv">3</span>, fig_size<span class="op">=</span>(<span class="dv">20</span>,<span class="dv">12</span>)):</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">assert</span> <span class="bu">len</span>(batch) <span class="op">&gt;=</span> n_rows <span class="op">*</span> n_cols, <span class="ss">f&quot;Not enough samples to display, required at least </span><span class="sc">{</span>n_rows <span class="op">*</span> n_cols<span class="sc">}</span><span class="ss"> samples&quot;</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>    fig, axs <span class="op">=</span> plt.subplots(n_rows, <span class="dv">1</span>, figsize<span class="op">=</span>fig_size)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    fig.tight_layout()</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>    imgs_with_boxes <span class="op">=</span> []</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> sample <span class="kw">in</span> batch[:n_rows <span class="op">*</span> n_cols]:</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> <span class="va">None</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(sample) <span class="op">==</span> <span class="dv">2</span>:</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>            image, boxes <span class="op">=</span> sample</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>            image, boxes, scores <span class="op">=</span> sample</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> [<span class="ss">f&quot;Score: </span><span class="sc">{</span>score<span class="sc">:.2f}</span><span class="ss">&quot;</span> <span class="cf">for</span> score <span class="kw">in</span> scores]</span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> draw_bounding_boxes(image<span class="op">=</span>image.permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>                                  boxes<span class="op">=</span>boxes,</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>                                  colors<span class="op">=</span>box_color,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>                                  labels<span class="op">=</span>scores,</span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>                                  width<span class="op">=</span>box_width)</span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a>        imgs_with_boxes.append(img)</span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axs):</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> titles:</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>            ax.set_title(titles[i], fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>        img_with_boxes <span class="op">=</span> make_grid(imgs_with_boxes[i <span class="op">*</span> n_cols: (i <span class="op">+</span> <span class="dv">1</span>) <span class="op">*</span> n_cols]).numpy()</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>        ax.imshow(np.transpose(img_with_boxes, (<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">0</span>)))</span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>sample_batch <span class="op">=</span> np.concatenate([sample_batch, np.random.choice(train_imgs, size<span class="op">=</span><span class="dv">13</span>)])</span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>sample_batch <span class="op">=</span> read_images(sample_batch, train_label_df, (train_img_size, train_img_size))</span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>plot_samples(sample_batch)</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_46156ca0a71b4f3087f219c9c1dd58c1/ab1449d1e96d693a8506fe74075d2b62a045e894.png" /></p>
</div>
</div>
<section
id="some-bounding-boxes-covers-small-part-of-the-lung-while-others-covers-most-of-the-lung"
class="cell markdown" id="jC3IMgAU24Qz">
<h4>Some bounding boxes covers small part of the lung while others
covers most of the lung.</h4>
</section>
<section id="image-augmentation" class="cell markdown"
id="Le0PhGQU24Q0">
<h3>Image augmentation</h3>
<h4
id="now-we-will-use-a-nifty-library-for-image-augmentation-imgaug-the-library-can-perform-geometric-transformations-along-with-bounding-boxes-masks-and-key-points-in-addition-we-add-some-noice-and-blur-to-image">Now
we will use a nifty library for image augmentation imgaug. The library
can perform geometric transformations along with bounding boxes, masks
and key points. In addition we add some noice and blur to image.</h4>
</section>
<div class="cell code" id="Mx939SJF24Q0" data-trusted="true">
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define a class &#39;Augmentation&#39; for applying image augmentations</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Augmentation:</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                 x_translation<span class="op">=</span>(<span class="op">-</span><span class="fl">0.05</span>, <span class="fl">0.05</span>),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                 rotate<span class="op">=</span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>),</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>                 scale<span class="op">=</span>(<span class="fl">0.9</span>, <span class="fl">1.1</span>),</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                 noice<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                 blur<span class="op">=</span>(<span class="dv">0</span>, <span class="fl">0.1</span>)):</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Define the augmentation transformations using imgaug.Sequential</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transform <span class="op">=</span> iaa.Sequential([</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>            iaa.Affine(translate_percent<span class="op">=</span>{<span class="st">&quot;x&quot;</span>: x_translation}, scale<span class="op">=</span>scale, rotate<span class="op">=</span>rotate),</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>            iaa.AdditiveGaussianNoise(scale<span class="op">=</span>noice),</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>            iaa.GaussianBlur(sigma<span class="op">=</span>blur)])</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Implement the __call__ method, which will be called when the class object is called as a function</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>, image, boxes):</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert the bounding boxes coordinates into imgaug format BoundingBoxesOnImage</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>        bbs <span class="op">=</span> BoundingBoxesOnImage([BoundingBox(x1<span class="op">=</span>box[<span class="dv">0</span>], y1<span class="op">=</span>box[<span class="dv">1</span>], x2<span class="op">=</span>box[<span class="dv">2</span>], y2<span class="op">=</span>box[<span class="dv">3</span>])</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">for</span> box <span class="kw">in</span> boxes], shape<span class="op">=</span>image.shape)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Apply the defined augmentations to the image and bounding boxes</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>        image, bbs <span class="op">=</span> <span class="va">self</span>.transform(image<span class="op">=</span>image, bounding_boxes<span class="op">=</span>bbs)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Convert the bounding boxes back to the original format (x1, y1, x2, y2) array</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> image, bbs.to_xyxy_array()</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Worker initialization function for multi-processing (not used in this code snippet)</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> worker_init_fn(<span class="va">self</span>, worker_id):</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Set a unique seed for each worker to ensure different augmentations.&quot;&quot;&quot;</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>        imgaug.seed(np.random.get_state()[<span class="dv">1</span>][<span class="dv">0</span>] <span class="op">+</span> worker_id)</span></code></pre></div>
</div>
<div class="cell code" id="9FzDh9TL24Q0" data-trusted="true">
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.transforms <span class="im">import</span> PILToTensor, ConvertImageDtype</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PneumoniaDataset(torch.utils.data.Dataset):</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, root, transforms, img_names, train_img_size, labels<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.root <span class="op">=</span> root</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.transforms <span class="op">=</span> transforms</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.img_names <span class="op">=</span> img_names</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.resize <span class="op">=</span> (train_img_size, train_img_size)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.labels <span class="op">=</span> labels</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">&quot;&quot;&quot;Load image, boxes and process them&quot;&quot;&quot;</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        img_name <span class="op">=</span> <span class="va">self</span>.img_names[idx]</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>        img_path <span class="op">=</span> os.path.join(<span class="va">self</span>.root, <span class="va">self</span>.img_names[idx])</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> PIL.Image.fromarray(pydicom.dcmread(img_path).pixel_array).convert(<span class="st">&quot;RGB&quot;</span>)</span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> img.resize(<span class="va">self</span>.resize)</span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> np.array(img)</span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.labels <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> torch.tensor(img <span class="op">/</span> <span class="fl">255.</span>).permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>).<span class="bu">float</span>()</span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-23"><a href="#cb21-23" aria-hidden="true" tabindex="-1"></a>        boxes, area <span class="op">=</span> find_boxes(img_name, <span class="va">self</span>.labels)</span>
<span id="cb21-24"><a href="#cb21-24" aria-hidden="true" tabindex="-1"></a>        n_objects <span class="op">=</span> <span class="bu">len</span>(boxes)</span>
<span id="cb21-25"><a href="#cb21-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="va">self</span>.transforms <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb21-26"><a href="#cb21-26" aria-hidden="true" tabindex="-1"></a>            img, boxes <span class="op">=</span> <span class="va">self</span>.transforms(img, boxes)</span>
<span id="cb21-27"><a href="#cb21-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-28"><a href="#cb21-28" aria-hidden="true" tabindex="-1"></a>        img <span class="op">=</span> torch.tensor(img <span class="op">/</span> <span class="fl">255.</span>).permute(<span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">1</span>).<span class="bu">float</span>()</span>
<span id="cb21-29"><a href="#cb21-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" aria-hidden="true" tabindex="-1"></a>        target <span class="op">=</span> {}</span>
<span id="cb21-31"><a href="#cb21-31" aria-hidden="true" tabindex="-1"></a>        target[<span class="st">&quot;image_id&quot;</span>] <span class="op">=</span> torch.tensor([idx])</span>
<span id="cb21-32"><a href="#cb21-32" aria-hidden="true" tabindex="-1"></a>        target[<span class="st">&quot;boxes&quot;</span>] <span class="op">=</span> torch.as_tensor(boxes, dtype<span class="op">=</span>torch.float32)</span>
<span id="cb21-33"><a href="#cb21-33" aria-hidden="true" tabindex="-1"></a>        target[<span class="st">&quot;labels&quot;</span>] <span class="op">=</span> torch.ones(n_objects, dtype<span class="op">=</span>torch.int64)</span>
<span id="cb21-34"><a href="#cb21-34" aria-hidden="true" tabindex="-1"></a>        target[<span class="st">&quot;area&quot;</span>] <span class="op">=</span> torch.as_tensor(area, dtype<span class="op">=</span>torch.float32)</span>
<span id="cb21-35"><a href="#cb21-35" aria-hidden="true" tabindex="-1"></a>        target[<span class="st">&quot;iscrowd&quot;</span>] <span class="op">=</span> torch.zeros(n_objects, dtype<span class="op">=</span>torch.int32)</span>
<span id="cb21-36"><a href="#cb21-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> img, target</span>
<span id="cb21-37"><a href="#cb21-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-38"><a href="#cb21-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb21-39"><a href="#cb21-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.img_names)</span>
<span id="cb21-40"><a href="#cb21-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-41"><a href="#cb21-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> collate_fn(<span class="va">self</span>, batch):</span>
<span id="cb21-42"><a href="#cb21-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">tuple</span>(<span class="bu">zip</span>(<span class="op">*</span>batch))</span></code></pre></div>
</div>
<div class="cell code" id="FvzQK2-q24Q0" data-trusted="true">
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> DataLoader</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>augmentation <span class="op">=</span> Augmentation()</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>train_ds <span class="op">=</span> PneumoniaDataset(os.path.join(ROOT_DIR, TRAIN_DIR), augmentation, train_imgs, train_img_size, train_label_df)</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>valid_ds <span class="op">=</span> PneumoniaDataset(os.path.join(ROOT_DIR, TRAIN_DIR), <span class="va">None</span>, valid_imgs, train_img_size, train_label_df)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>test_ds <span class="op">=</span> PneumoniaDataset(os.path.join(ROOT_DIR, TEST_DIR), <span class="va">None</span>, test_imgs, train_img_size)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>train_loader <span class="op">=</span> DataLoader(train_ds, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">True</span>, num_workers<span class="op">=</span><span class="dv">2</span>, collate_fn<span class="op">=</span>train_ds.collate_fn,</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>                          worker_init_fn<span class="op">=</span>augmentation.worker_init_fn)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>valid_loader <span class="op">=</span> DataLoader(valid_ds, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>, collate_fn<span class="op">=</span>valid_ds.collate_fn)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>test_loader <span class="op">=</span> DataLoader(test_ds, batch_size<span class="op">=</span>batch_size, shuffle<span class="op">=</span><span class="va">False</span>, num_workers<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="C7QLWMj5g-aT" data-outputId="87185ff8-7163-469c-a2a6-ff5d5c5e1ef2">
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>pip install imgaug</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Requirement already satisfied: imgaug in /usr/local/lib/python3.10/dist-packages (0.4.0)
Requirement already satisfied: six in /usr/local/lib/python3.10/dist-packages (from imgaug) (1.16.0)
Requirement already satisfied: numpy&gt;=1.15 in /usr/local/lib/python3.10/dist-packages (from imgaug) (1.22.4)
Requirement already satisfied: scipy in /usr/local/lib/python3.10/dist-packages (from imgaug) (1.10.1)
Requirement already satisfied: Pillow in /usr/local/lib/python3.10/dist-packages (from imgaug) (9.4.0)
Requirement already satisfied: matplotlib in /usr/local/lib/python3.10/dist-packages (from imgaug) (3.7.1)
Requirement already satisfied: scikit-image&gt;=0.14.2 in /usr/local/lib/python3.10/dist-packages (from imgaug) (0.19.3)
Requirement already satisfied: opencv-python in /usr/local/lib/python3.10/dist-packages (from imgaug) (4.7.0.72)
Requirement already satisfied: imageio in /usr/local/lib/python3.10/dist-packages (from imgaug) (2.25.1)
Requirement already satisfied: Shapely in /usr/local/lib/python3.10/dist-packages (from imgaug) (2.0.1)
Requirement already satisfied: networkx&gt;=2.2 in /usr/local/lib/python3.10/dist-packages (from scikit-image&gt;=0.14.2-&gt;imgaug) (3.1)
Requirement already satisfied: tifffile&gt;=2019.7.26 in /usr/local/lib/python3.10/dist-packages (from scikit-image&gt;=0.14.2-&gt;imgaug) (2023.7.18)
Requirement already satisfied: PyWavelets&gt;=1.1.1 in /usr/local/lib/python3.10/dist-packages (from scikit-image&gt;=0.14.2-&gt;imgaug) (1.4.1)
Requirement already satisfied: packaging&gt;=20.0 in /usr/local/lib/python3.10/dist-packages (from scikit-image&gt;=0.14.2-&gt;imgaug) (23.1)
Requirement already satisfied: contourpy&gt;=1.0.1 in /usr/local/lib/python3.10/dist-packages (from matplotlib-&gt;imgaug) (1.1.0)
Requirement already satisfied: cycler&gt;=0.10 in /usr/local/lib/python3.10/dist-packages (from matplotlib-&gt;imgaug) (0.11.0)
Requirement already satisfied: fonttools&gt;=4.22.0 in /usr/local/lib/python3.10/dist-packages (from matplotlib-&gt;imgaug) (4.41.1)
Requirement already satisfied: kiwisolver&gt;=1.0.1 in /usr/local/lib/python3.10/dist-packages (from matplotlib-&gt;imgaug) (1.4.4)
Requirement already satisfied: pyparsing&gt;=2.3.1 in /usr/local/lib/python3.10/dist-packages (from matplotlib-&gt;imgaug) (3.1.0)
Requirement already satisfied: python-dateutil&gt;=2.7 in /usr/local/lib/python3.10/dist-packages (from matplotlib-&gt;imgaug) (2.8.2)
</code></pre>
</div>
</div>
<div class="cell code" id="tRmovxgLhBr3">
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> imgaug</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:726}"
id="Zts1-5Fk24Q0" data-outputId="d26c5d52-b9ea-4793-ec52-00550ae8dcb8">
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_batch(idx, sample):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    img, boxes <span class="op">=</span> sample</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    augmentation <span class="op">=</span> Augmentation()</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    augmentation.worker_init_fn(idx)</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>    img, boxes <span class="op">=</span> augmentation(img.numpy(), boxes.numpy())</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> torch.tensor(img, dtype<span class="op">=</span>torch.uint8)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    boxes <span class="op">=</span> torch.tensor(boxes, dtype<span class="op">=</span>torch.float32)</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img, boxes</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>augmented_batch <span class="op">=</span> sample_batch[:<span class="dv">5</span>] <span class="op">+</span> [process_batch(i, sample) <span class="cf">for</span> i, sample <span class="kw">in</span> <span class="bu">enumerate</span>(sample_batch[:<span class="dv">5</span>])]</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>plot_samples(augmented_batch, titles<span class="op">=</span>[<span class="st">&quot;Original images&quot;</span>, <span class="st">&quot;Augmented images&quot;</span>], fig_size<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">10</span>), n_rows<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span> sample_batch, augmented_batch</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_46156ca0a71b4f3087f219c9c1dd58c1/a86e866b05fe70f704ff8c1cad3e572917607c26.png" /></p>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="CaMauylUg6JP" data-outputId="130a0cb3-3ae2-474f-fe41-88758003fc04">
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>pip install pytorch_lightning</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Collecting pytorch_lightning
  Downloading pytorch_lightning-2.0.6-py3-none-any.whl (722 kB)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 722.8/722.8 kB 5.1 MB/s eta 0:00:00
ent already satisfied: numpy&gt;=1.17.2 in /usr/local/lib/python3.10/dist-packages (from pytorch_lightning) (1.22.4)
Requirement already satisfied: torch&gt;=1.11.0 in /usr/local/lib/python3.10/dist-packages (from pytorch_lightning) (2.0.1+cu118)
Requirement already satisfied: tqdm&gt;=4.57.0 in /usr/local/lib/python3.10/dist-packages (from pytorch_lightning) (4.65.0)
Requirement already satisfied: PyYAML&gt;=5.4 in /usr/local/lib/python3.10/dist-packages (from pytorch_lightning) (6.0.1)
Requirement already satisfied: fsspec[http]&gt;2021.06.0 in /usr/local/lib/python3.10/dist-packages (from pytorch_lightning) (2023.6.0)
Collecting torchmetrics&gt;=0.7.0 (from pytorch_lightning)
  Downloading torchmetrics-1.0.2-py3-none-any.whl (731 kB)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ 731.1/731.1 kB 9.6 MB/s eta 0:00:00
ent already satisfied: packaging&gt;=17.1 in /usr/local/lib/python3.10/dist-packages (from pytorch_lightning) (23.1)
Requirement already satisfied: typing-extensions&gt;=4.0.0 in /usr/local/lib/python3.10/dist-packages (from pytorch_lightning) (4.7.1)
Collecting lightning-utilities&gt;=0.7.0 (from pytorch_lightning)
  Downloading lightning_utilities-0.9.0-py3-none-any.whl (23 kB)
Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (2.27.1)
Requirement already satisfied: aiohttp!=4.0.0a0,!=4.0.0a1 in /usr/local/lib/python3.10/dist-packages (from fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (3.8.5)
Requirement already satisfied: filelock in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.11.0-&gt;pytorch_lightning) (3.12.2)
Requirement already satisfied: sympy in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.11.0-&gt;pytorch_lightning) (1.11.1)
Requirement already satisfied: networkx in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.11.0-&gt;pytorch_lightning) (3.1)
Requirement already satisfied: jinja2 in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.11.0-&gt;pytorch_lightning) (3.1.2)
Requirement already satisfied: triton==2.0.0 in /usr/local/lib/python3.10/dist-packages (from torch&gt;=1.11.0-&gt;pytorch_lightning) (2.0.0)
Requirement already satisfied: cmake in /usr/local/lib/python3.10/dist-packages (from triton==2.0.0-&gt;torch&gt;=1.11.0-&gt;pytorch_lightning) (3.25.2)
Requirement already satisfied: lit in /usr/local/lib/python3.10/dist-packages (from triton==2.0.0-&gt;torch&gt;=1.11.0-&gt;pytorch_lightning) (16.0.6)
Requirement already satisfied: attrs&gt;=17.3.0 in /usr/local/lib/python3.10/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (23.1.0)
Requirement already satisfied: charset-normalizer&lt;4.0,&gt;=2.0 in /usr/local/lib/python3.10/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (2.0.12)
Requirement already satisfied: multidict&lt;7.0,&gt;=4.5 in /usr/local/lib/python3.10/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (6.0.4)
Requirement already satisfied: async-timeout&lt;5.0,&gt;=4.0.0a3 in /usr/local/lib/python3.10/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (4.0.2)
Requirement already satisfied: yarl&lt;2.0,&gt;=1.0 in /usr/local/lib/python3.10/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (1.9.2)
Requirement already satisfied: frozenlist&gt;=1.1.1 in /usr/local/lib/python3.10/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (1.4.0)
Requirement already satisfied: aiosignal&gt;=1.1.2 in /usr/local/lib/python3.10/dist-packages (from aiohttp!=4.0.0a0,!=4.0.0a1-&gt;fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (1.3.1)
Requirement already satisfied: MarkupSafe&gt;=2.0 in /usr/local/lib/python3.10/dist-packages (from jinja2-&gt;torch&gt;=1.11.0-&gt;pytorch_lightning) (2.1.3)
Requirement already satisfied: urllib3&lt;1.27,&gt;=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (1.26.16)
Requirement already satisfied: certifi&gt;=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (2023.7.22)
Requirement already satisfied: idna&lt;4,&gt;=2.5 in /usr/local/lib/python3.10/dist-packages (from requests-&gt;fsspec[http]&gt;2021.06.0-&gt;pytorch_lightning) (3.4)
Requirement already satisfied: mpmath&gt;=0.19 in /usr/local/lib/python3.10/dist-packages (from sympy-&gt;torch&gt;=1.11.0-&gt;pytorch_lightning) (1.3.0)
Installing collected packages: lightning-utilities, torchmetrics, pytorch_lightning
Successfully installed lightning-utilities-0.9.0 pytorch_lightning-2.0.6 torchmetrics-1.0.2
</code></pre>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}"
id="KXY66jlNhIk7" data-outputId="87e2b0c5-80dd-4fe6-de90-cf12b976cc2f">
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pytorch_lightning <span class="im">as</span> pl</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.ops <span class="im">import</span> nms</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.models.detection.faster_rcnn <span class="im">import</span> FastRCNNPredictor</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LitRCNN(pl.LightningModule):</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, num_classes):</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> torchvision.models.detection.fasterrcnn_resnet50_fpn(pretrained<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        in_features <span class="op">=</span> model.roi_heads.box_predictor.cls_score.in_features</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>        model.roi_heads.box_predictor <span class="op">=</span> FastRCNNPredictor(in_features, num_classes)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model <span class="op">=</span> model</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.<span class="bu">eval</span>()</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        outputs <span class="op">=</span>  <span class="va">self</span>.model(x)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        preds <span class="op">=</span> []</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> output <span class="kw">in</span> outputs:</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>            boxes <span class="op">=</span> output[<span class="st">&quot;boxes&quot;</span>]</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>            scores <span class="op">=</span> output[<span class="st">&quot;scores&quot;</span>]</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>            idx <span class="op">=</span> nms(boxes,scores, <span class="fl">0.05</span>)</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>            preds.append({<span class="st">&quot;boxes&quot;</span>: boxes[idx].cpu().detach().numpy(), <span class="st">&quot;scores&quot;</span>: scores[idx].cpu().detach().numpy()})</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> preds</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> training_step(<span class="va">self</span>, batch, batch_idx):</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        images, targets <span class="op">=</span> batch</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>        losses <span class="op">=</span> <span class="va">self</span>.model(images, targets)</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="bu">sum</span>(loss <span class="cf">for</span> loss <span class="kw">in</span> losses.values())</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log_losses(loss, losses)</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> loss</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> validation_step(<span class="va">self</span>, batch, batch_idx):</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.model.train()</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>        images, targets <span class="op">=</span> batch</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>        losses <span class="op">=</span> <span class="va">self</span>.model(images, targets)</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>        loss <span class="op">=</span> <span class="bu">sum</span>(loss <span class="cf">for</span> loss <span class="kw">in</span> losses.values())</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log_losses(loss, losses, mode<span class="op">=</span><span class="st">&quot;val&quot;</span>)</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> predict_step(<span class="va">self</span>, batch, batch_idx):</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.forward(batch)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> configure_optimizers(<span class="va">self</span>):</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>        optimizer <span class="op">=</span> torch.optim.SGD(<span class="va">self</span>.parameters(),  lr<span class="op">=</span><span class="fl">0.005</span>, momentum<span class="op">=</span><span class="fl">0.9</span>, weight_decay<span class="op">=</span><span class="fl">0.0005</span>)</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>        scheduler <span class="op">=</span> torch.optim.lr_scheduler.StepLR(optimizer, step_size<span class="op">=</span><span class="dv">1</span>, gamma<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;optimizer&quot;</span>: optimizer,</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;lr_scheduler&quot;</span>: {</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;scheduler&quot;</span>: scheduler,</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;interval&quot;</span>: <span class="st">&quot;epoch&quot;</span>,</span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;frequency&quot;</span>: <span class="dv">1</span>}}</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> log_losses(<span class="va">self</span>, loss, losses, mode<span class="op">=</span><span class="st">&quot;train&quot;</span>):</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.log_dict({<span class="ss">f&quot;</span><span class="sc">{</span>mode<span class="sc">}</span><span class="ss">_loss&quot;</span>: loss,</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>                       <span class="ss">f&quot;</span><span class="sc">{</span>mode<span class="sc">}</span><span class="ss">_loss_box_reg&quot;</span>: losses[<span class="st">&#39;loss_box_reg&#39;</span>],</span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>                       <span class="ss">f&quot;</span><span class="sc">{</span>mode<span class="sc">}</span><span class="ss">_loss_objectness&quot;</span>: losses[<span class="st">&#39;loss_objectness&#39;</span>],</span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>                       <span class="ss">f&quot;</span><span class="sc">{</span>mode<span class="sc">}</span><span class="ss">_loss_rpn_box_reg&quot;</span>: losses[<span class="st">&#39;loss_rpn_box_reg&#39;</span>]}, on_step<span class="op">=</span><span class="va">False</span>, on_epoch<span class="op">=</span><span class="va">True</span>, batch_size<span class="op">=</span>batch_size)</span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> LitRCNN(num_classes)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>Downloading: &quot;https://download.pytorch.org/models/fasterrcnn_resnet50_fpn_coco-258fb6c6.pth&quot; to /root/.cache/torch/hub/checkpoints/fasterrcnn_resnet50_fpn_coco-258fb6c6.pth
100%|██████████| 160M/160M [00:02&lt;00:00, 77.8MB/s]
</code></pre>
</div>
</div>
<div class="cell markdown" id="E4JITWQohLEb">
<p>We define some callbacks for logging and model checkpoints.</p>
</div>
<div class="cell code" id="a9B2oqKPhVZ2">
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytorch_lightning <span class="im">import</span> Callback</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytorch_lightning.callbacks <span class="im">import</span> ModelCheckpoint</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MetricsCallback(Callback):</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;PyTorch Lightning metric callback.&quot;&quot;&quot;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, metrics):</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.metrics <span class="op">=</span> metrics</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.training <span class="op">=</span> {}</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.validations <span class="op">=</span> {}</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_train_epoch_end(<span class="va">self</span>, trainer, pl_module):</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.training[trainer.current_epoch] <span class="op">=</span> {metric: trainer.callback_metrics[<span class="st">&quot;train_&quot;</span> <span class="op">+</span> metric] <span class="cf">for</span> metric <span class="kw">in</span> <span class="va">self</span>.metrics}</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> on_validation_end(<span class="va">self</span>, trainer, pl_module):</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.validations[trainer.current_epoch] <span class="op">=</span> {metric: trainer.callback_metrics[<span class="st">&quot;val_&quot;</span> <span class="op">+</span> metric] <span class="cf">for</span> metric <span class="kw">in</span> <span class="va">self</span>.metrics}</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>checkpoint_callback <span class="op">=</span> ModelCheckpoint(dirpath<span class="op">=</span><span class="st">&#39;checkpoints&#39;</span>,</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>                                      filename<span class="op">=</span><span class="st">&#39;</span><span class="sc">{epoch}</span><span class="st">-</span><span class="sc">{val_loss:.4f}</span><span class="st">&#39;</span>,</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>                                      every_n_epochs<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>                                      monitor<span class="op">=</span><span class="st">&#39;val_loss&#39;</span>,</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>                                      save_top_k<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>                                      mode<span class="op">=</span><span class="st">&#39;min&#39;</span>)</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>callbacks <span class="op">=</span> [MetricsCallback([<span class="st">&quot;loss&quot;</span>] <span class="op">+</span> rcnn_losses), checkpoint_callback]</span></code></pre></div>
</div>
<section id="training" class="cell markdown" id="1CUjQH1nhhI4">
<h2>Training</h2>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:327,&quot;referenced_widgets&quot;:[&quot;e36cc02ba14a47dbba9140e7e13b5c8b&quot;,&quot;dee094d250e044919da5dcf252779ef6&quot;,&quot;fd677e09f69f4ad897aa4bab87377c08&quot;,&quot;56eca5bbb5384bc99439beb0db303692&quot;,&quot;f4d52ca74e6640bfac29d18cf7b8a204&quot;,&quot;a09a334352064c28bef87d4fa6d4e6b6&quot;,&quot;9b71c706717b400488381b1102509520&quot;,&quot;464f179309254015849f7b20b159ff76&quot;,&quot;82254c249cc54c909acc6b0577beabcb&quot;,&quot;3b4fa90b8f604752a312838d298ce76b&quot;,&quot;7f11cdef9144421e94e78b13f2c639c5&quot;,&quot;1eca35d730bf4b8cbe646e1ec54ed2f8&quot;,&quot;a08adf1d785449b48f9e804e1fb1adea&quot;,&quot;7cc117d23b6046879f10b45057e1e484&quot;,&quot;7f7b15fdd3a841308d16e4be0f2c9422&quot;,&quot;e7ce3fa43aec40e6a302164e8538e8cc&quot;,&quot;e5334e285cee4242af7eaa4ae4047a5f&quot;,&quot;92fa75a59bc94b39b098aafc1bb1d80f&quot;,&quot;3459189660d04f88aaf252fbf61054bd&quot;,&quot;48efa63f15f142b396069edef3ab1fc7&quot;,&quot;8ad4c3ab7aec4fc493c0e3815781844c&quot;,&quot;e048946db94f4f70b15633d79770f293&quot;,&quot;6f39bcc9964440bebbf6db4d7947ed02&quot;,&quot;e1164aa3cdf04deeab49297d2fecba6e&quot;,&quot;31015f2c504c44869316be223be1884f&quot;,&quot;50bc0710f75747989066e97814862e1e&quot;,&quot;0d8fffd2a5b44afc9182ce418b9e33fb&quot;,&quot;d6390f72e4104f3d8f45d28456f4596f&quot;,&quot;373c0158999141a8af5385bf6b002048&quot;,&quot;cf6af01a4fbe49109b924893f7824e9e&quot;,&quot;877889a8f8d04fa28922ea2ac1b42fa8&quot;,&quot;1fb8e2854df941beae0f3d6690ec5522&quot;,&quot;dba9d0b1d3464bd4a5684518756085c4&quot;]}"
id="VemG623DhXvA" data-outputId="da59c2ee-a5eb-4d20-8e7c-22f7abd22e20">
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> <span class="st">&quot;gpu&quot;</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">&quot;cpu&quot;</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>trainer <span class="op">=</span> pl.Trainer(accelerator<span class="op">=</span>device, max_epochs<span class="op">=</span><span class="dv">1</span>, callbacks<span class="op">=</span>callbacks)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>trainer.fit(model<span class="op">=</span>model, train_dataloaders<span class="op">=</span>train_loader, val_dataloaders<span class="op">=</span>valid_loader)</span></code></pre></div>
<div class="output stream stderr">
<pre><code>INFO:pytorch_lightning.utilities.rank_zero:GPU available: True (cuda), used: True
INFO:pytorch_lightning.utilities.rank_zero:TPU available: False, using: 0 TPU cores
INFO:pytorch_lightning.utilities.rank_zero:IPU available: False, using: 0 IPUs
INFO:pytorch_lightning.utilities.rank_zero:HPU available: False, using: 0 HPUs
WARNING:pytorch_lightning.loggers.tensorboard:Missing logger folder: /content/lightning_logs
INFO:pytorch_lightning.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
INFO:pytorch_lightning.callbacks.model_summary:
  | Name  | Type       | Params
-------------------------------------
0 | model | FasterRCNN | 41.3 M
-------------------------------------
41.1 M    Trainable params
222 K     Non-trainable params
41.3 M    Total params
165.197   Total estimated model params size (MB)
</code></pre>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb34"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;e36cc02ba14a47dbba9140e7e13b5c8b&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb35"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;1eca35d730bf4b8cbe646e1ec54ed2f8&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb36"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;6f39bcc9964440bebbf6db4d7947ed02&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output stream stderr">
<pre><code>INFO:pytorch_lightning.utilities.rank_zero:`Trainer.fit` stopped: `max_epochs=1` reached.
</code></pre>
</div>
</div>
<section id="evaluation" class="cell markdown" id="6jWB88skho6Q">
<h2>Evaluation</h2>
<p>Now we can check some predictions on validation set.</p>
</section>
<div class="cell code" id="xh-yoVsihbYD">
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>sample_batch_idx <span class="op">=</span> np.random.choice(<span class="bu">len</span>(valid_imgs), size<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>sample_batch <span class="op">=</span> read_images(np.array(valid_ds.img_names)[sample_batch_idx], train_label_df, (train_img_size, train_img_size))</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> model([valid_ds[i][<span class="dv">0</span>] <span class="cf">for</span> i <span class="kw">in</span> sample_batch_idx])</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, pred <span class="kw">in</span> <span class="bu">enumerate</span>(preds):</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    sample_batch.append((sample_batch[i][<span class="dv">0</span>],</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>                         torch.tensor(pred[<span class="st">&quot;boxes&quot;</span>], dtype<span class="op">=</span>torch.int32),</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>                         pred[<span class="st">&quot;scores&quot;</span>]))</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>plot_samples(sample_batch, titles<span class="op">=</span>[<span class="st">&quot;Validation&quot;</span>, <span class="st">&quot;Predictions&quot;</span>], fig_size<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">10</span>), n_rows<span class="op">=</span><span class="dv">2</span>)</span></code></pre></div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:821}"
id="l0KjHaBthudV" data-outputId="c86040ca-da97-49c3-c24c-394b8123718c">
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>sns.set_style(<span class="st">&quot;whitegrid&quot;</span>)</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>training <span class="op">=</span> pd.DataFrame.from_dict(callbacks[<span class="dv">0</span>].training, orient<span class="op">=</span><span class="st">&quot;index&quot;</span>).applymap(<span class="kw">lambda</span> x: x.cpu().numpy())</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>validations <span class="op">=</span> pd.DataFrame.from_dict(callbacks[<span class="dv">0</span>].validations, orient<span class="op">=</span><span class="st">&quot;index&quot;</span>).applymap(<span class="kw">lambda</span> x: x.cpu().numpy())</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>fig, axs <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">8</span>))</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ax, metric <span class="kw">in</span> <span class="bu">zip</span>(axs.flat, callbacks[<span class="dv">0</span>].metrics):</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    ax.set_title(metric)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check if the metric key exists in the DataFrames</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> metric <span class="kw">in</span> training.index <span class="kw">and</span> metric <span class="kw">in</span> validations.index:</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract the numeric values for the specific metric</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>        training_metric_values <span class="op">=</span> training.loc[metric].values</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        validations_metric_values <span class="op">=</span> validations.loc[metric].values</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Use the numeric values for the lineplot</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> sns.lineplot(data<span class="op">=</span>training_metric_values, ax<span class="op">=</span>ax)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>        g <span class="op">=</span> sns.lineplot(data<span class="op">=</span>validations_metric_values, ax<span class="op">=</span>ax)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>        g.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">&quot;Epoch&quot;</span>, ylabel<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>        g.set_xticks(<span class="bu">range</span>(<span class="dv">1</span>, <span class="bu">len</span>(training_metric_values) <span class="op">+</span> <span class="dv">1</span>))  <span class="co"># Assuming epoch numbers start from 1</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>        ax.legend(labels<span class="op">=</span>[<span class="st">&quot;Training&quot;</span>, <span class="st">&quot;Validation&quot;</span>])</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Warning: Metric &#39;</span><span class="sc">{</span>metric<span class="sc">}</span><span class="ss">&#39; not found in the DataFrames.&quot;</span>)</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>fig.tight_layout()</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Warning: Metric &#39;loss&#39; not found in the DataFrames.
Warning: Metric &#39;loss_objectness&#39; not found in the DataFrames.
Warning: Metric &#39;loss_box_reg&#39; not found in the DataFrames.
Warning: Metric &#39;loss_rpn_box_reg&#39; not found in the DataFrames.
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_46156ca0a71b4f3087f219c9c1dd58c1/40d900409b6fc1edb9cd7109d10fde4de5bd907a.png" /></p>
</div>
</div>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:224,&quot;referenced_widgets&quot;:[&quot;59b149a39e9a43ad9cdbfb4c2b24c304&quot;,&quot;52f2a42ebdf944f1afcd80fb89320d93&quot;,&quot;ece78be90ef3466497c8d099ac3ac70c&quot;,&quot;7116139c32b34517899b8f15e4d3a314&quot;,&quot;affce55c49fb4f8f92ff9dec39bc5600&quot;,&quot;22e56e1f3ce64b32b93df7cd67d818e3&quot;,&quot;691e570252ac4537a1af2b3940017155&quot;,&quot;2e1f0c31afe7461fbcebd4aedc3506fe&quot;,&quot;1f34322afd1e4980bc80118992c8439f&quot;,&quot;cb981152d2374acbae6c7675b4016b6f&quot;,&quot;18622ea7c5ef476d83cec90f741af01c&quot;]}"
id="HpskcRGLhu-S" data-outputId="ebb5158f-9957-4321-96fc-81244a565cd8">
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>history <span class="op">=</span> trainer.validate(model, dataloaders<span class="op">=</span>valid_loader, verbose<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>pd.DataFrame(history, index<span class="op">=</span>[<span class="st">&quot;Validation&quot;</span>]).T</span></code></pre></div>
<div class="output stream stderr">
<pre><code>INFO:pytorch_lightning.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</code></pre>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb43"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;59b149a39e9a43ad9cdbfb4c2b24c304&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output execute_result" data-execution_count="138">


  <div id="df-a90716e6-4eab-4021-bdd4-45a0321affd3">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Validation</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>val_loss</th>
      <td>0.073671</td>
    </tr>
    <tr>
      <th>val_loss_box_reg</th>
      <td>0.034431</td>
    </tr>
    <tr>
      <th>val_loss_objectness</th>
      <td>0.004091</td>
    </tr>
    <tr>
      <th>val_loss_rpn_box_reg</th>
      <td>0.001276</td>
    </tr>
  </tbody>
</table>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-a90716e6-4eab-4021-bdd4-45a0321affd3')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>



    <div id="df-24c324bd-fc72-47ba-8785-23df37521819">
      <button class="colab-df-quickchart" onclick="quickchart('df-24c324bd-fc72-47ba-8785-23df37521819')"
              title="Suggest charts."
              style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>
    </div>

<style>
  .colab-df-quickchart {
    background-color: #E8F0FE;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: #1967D2;
    height: 32px;
    padding: 0 0 0 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: #E2EBFA;
    box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: #174EA6;
  }

  [theme=dark] .colab-df-quickchart {
    background-color: #3B4455;
    fill: #D2E3FC;
  }

  [theme=dark] .colab-df-quickchart:hover {
    background-color: #434B5C;
    box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
    filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
    fill: #FFFFFF;
  }
</style>

    <script>
      async function quickchart(key) {
        const containerElement = document.querySelector('#' + key);
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      }
    </script>

      <script>

function displayQuickchartButton(domScope) {
  let quickchartButtonEl =
    domScope.querySelector('#df-24c324bd-fc72-47ba-8785-23df37521819 button.colab-df-quickchart');
  quickchartButtonEl.style.display =
    google.colab.kernel.accessAllowed ? 'block' : 'none';
}

        displayQuickchartButton(document);
      </script>
      <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-a90716e6-4eab-4021-bdd4-45a0321affd3 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-a90716e6-4eab-4021-bdd4-45a0321affd3');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>

</div>
</div>
<section id="submission" class="cell markdown" id="oWxwHZbKhz-S">
<h2>Submission</h2>
</section>
<div class="cell code"
data-colab="{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;,&quot;height&quot;:473,&quot;referenced_widgets&quot;:[&quot;3acd758455e6403791e541c809aaff86&quot;,&quot;1373754bd3c74e27ba9cf7d4cd54dae9&quot;,&quot;e2a6a7d360064c5ba89547821916a56b&quot;,&quot;0bf9549449a54571a1b9adf541d2e682&quot;,&quot;ce20816a6d0248f38f21a6e506d95f03&quot;,&quot;868946d2f3f64f93b535b5bc9e23b9f6&quot;,&quot;5f16ab61059548368ad048b55ab4ff63&quot;,&quot;55c3a56330e1436084e9dd2b16b39a0f&quot;,&quot;2c5acd584438400eb2b34cd472442929&quot;,&quot;0ead2aadbf7d43bcad2c2bfe23667095&quot;,&quot;6fe1033effeb459990facca01f497c9c&quot;]}"
id="pAR-Xfgph2qo" data-outputId="58afd7e6-9bc1-41f5-c995-56a88ff31bf2">
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> trainer.predict(model, test_loader)</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>outputs <span class="op">=</span> []</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> batch_pred <span class="kw">in</span> preds:</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> sample_pred <span class="kw">in</span> batch_pred:</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        scores, boxes <span class="op">=</span> sample_pred[<span class="st">&quot;scores&quot;</span>], sample_pred[<span class="st">&quot;boxes&quot;</span>]</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">len</span>(scores) <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>            outputs.append(np.nan)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> <span class="st">&quot;&quot;</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>            boxes <span class="op">=</span> boxes <span class="op">/</span> scale_factor</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> score, box <span class="kw">in</span> <span class="bu">zip</span>(scores, boxes):</span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>                label <span class="op">+=</span> <span class="ss">f&quot;</span><span class="sc">{</span>score<span class="sc">:.2f}</span><span class="ss"> </span><span class="sc">{</span>box[<span class="dv">0</span>]<span class="sc">:.1f}</span><span class="ss"> </span><span class="sc">{</span>box[<span class="dv">1</span>]<span class="sc">:.1f}</span><span class="ss"> </span><span class="sc">{</span>(box[<span class="dv">2</span>]<span class="op">-</span>box[<span class="dv">0</span>])<span class="sc">:.1f}</span><span class="ss"> </span><span class="sc">{</span>(box[<span class="dv">3</span>]<span class="op">-</span>box[<span class="dv">1</span>])<span class="sc">:.1f}</span><span class="ss"> &quot;</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>            outputs.append(label.strip())</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>submission <span class="op">=</span> pd.read_csv(os.path.join(ROOT_DIR, SUBMISSION_FILE))</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>submission.PredictionString <span class="op">=</span> outputs</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>submission.to_csv(<span class="st">&quot;submission.csv&quot;</span>, header<span class="op">=</span><span class="va">True</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>submission</span></code></pre></div>
<div class="output stream stderr">
<pre><code>INFO:pytorch_lightning.accelerators.cuda:LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]
</code></pre>
</div>
<div class="output display_data">
<div class="sourceCode" id="cb46"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="dt">&quot;model_id&quot;</span><span class="fu">:</span><span class="st">&quot;3acd758455e6403791e541c809aaff86&quot;</span><span class="fu">,</span><span class="dt">&quot;version_major&quot;</span><span class="fu">:</span><span class="dv">2</span><span class="fu">,</span><span class="dt">&quot;version_minor&quot;</span><span class="fu">:</span><span class="dv">0</span><span class="fu">}</span></span></code></pre></div>
</div>
<div class="output execute_result" data-execution_count="139">


  <div id="df-c9f5872e-5329-430b-b7a4-b7b838eea4f4">
    <div class="colab-df-container">
      <div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>patientId</th>
      <th>PredictionString</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0000a175-0e68-4ca4-b1af-167204a7e0bc</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0005d3cc-3c3f-40b9-93c3-46231c3eb813</td>
      <td>0.25 314.2 203.2 130.3 179.1 0.11 660.3 479.5 ...</td>
    </tr>
    <tr>
      <th>2</th>
      <td>000686d7-f4fc-448d-97a0-44fa9c5d3aa6</td>
      <td>0.08 179.2 495.9 274.8 258.8 0.06 758.6 570.1 ...</td>
    </tr>
    <tr>
      <th>3</th>
      <td>000e3a7d-c0ca-4349-bb26-5af2d8993c3d</td>
      <td>0.11 230.5 407.1 223.1 313.8</td>
    </tr>
    <tr>
      <th>4</th>
      <td>00100a24-854d-423d-a092-edcf6179e061</td>
      <td>0.57 251.1 599.2 148.0 193.5 0.56 515.2 345.1 ...</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>2995</th>
      <td>c1e88810-9e4e-4f39-9306-8d314bfc1ff1</td>
      <td>0.42 338.6 146.0 191.3 382.8 0.29 621.2 586.1 ...</td>
    </tr>
    <tr>
      <th>2996</th>
      <td>c1ec035b-377b-416c-a281-f868b7c9b6c3</td>
      <td>0.29 253.3 580.6 203.3 191.0</td>
    </tr>
    <tr>
      <th>2997</th>
      <td>c1ef5b66-0fd7-49d1-ae6b-5af84929414b</td>
      <td>0.14 243.3 394.4 195.9 363.1 0.07 631.3 533.1 ...</td>
    </tr>
    <tr>
      <th>2998</th>
      <td>c1ef6724-f95f-40f1-b25b-de806d9bc39d</td>
      <td>0.72 215.6 327.6 246.2 395.6 0.28 617.0 342.1 ...</td>
    </tr>
    <tr>
      <th>2999</th>
      <td>c1f55e7e-4065-4dc0-993e-a7c1704c6036</td>
      <td>0.12 157.4 539.7 257.9 219.3</td>
    </tr>
  </tbody>
</table>
<p>3000 rows × 2 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-c9f5872e-5329-430b-b7a4-b7b838eea4f4')"
              title="Convert this dataframe to an interactive table."
              style="display:none;">

  <svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
       width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"/>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"/><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"/>
  </svg>
      </button>



    <div id="df-b1d6678c-3eeb-4ced-8ad3-b6729eb08ec8">
      <button class="colab-df-quickchart" onclick="quickchart('df-b1d6678c-3eeb-4ced-8ad3-b6729eb08ec8')"
              title="Suggest charts."
              style="display:none;">

<svg xmlns="http://www.w3.org/2000/svg" height="24px"viewBox="0 0 24 24"
     width="24px">
    <g>
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
    </g>
</svg>
      </button>
    </div>

<style>
  .colab-df-quickchart {
    background-color: #E8F0FE;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: none;
    fill: #1967D2;
    height: 32px;
    padding: 0 0 0 0;
    width: 32px;
  }

  .colab-df-quickchart:hover {
    background-color: #E2EBFA;
    box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
    fill: #174EA6;
  }

  [theme=dark] .colab-df-quickchart {
    background-color: #3B4455;
    fill: #D2E3FC;
  }

  [theme=dark] .colab-df-quickchart:hover {
    background-color: #434B5C;
    box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
    filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
    fill: #FFFFFF;
  }
</style>

    <script>
      async function quickchart(key) {
        const containerElement = document.querySelector('#' + key);
        const charts = await google.colab.kernel.invokeFunction(
            'suggestCharts', [key], {});
      }
    </script>

      <script>

function displayQuickchartButton(domScope) {
  let quickchartButtonEl =
    domScope.querySelector('#df-b1d6678c-3eeb-4ced-8ad3-b6729eb08ec8 button.colab-df-quickchart');
  quickchartButtonEl.style.display =
    google.colab.kernel.accessAllowed ? 'block' : 'none';
}

        displayQuickchartButton(document);
      </script>
      <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-c9f5872e-5329-430b-b7a4-b7b838eea4f4 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-c9f5872e-5329-430b-b7a4-b7b838eea4f4');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>

</div>
</div>
</body>
</html>
